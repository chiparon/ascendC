# MatmulLeakyRelu（Ascend C）上下文压缩（2026-02-16）

## 1. 总目标（持续不变）
- 在高维 shape（至少 `(2048,2048,2048)`、`(4096,1024,4096)`）下，性能较 baseline 提升 `>=20%`。
- 接口兼容、功能正确（误差可控）。
- 保留 baseline 与 optimized 两套可独立构建运行路径。
- 输出瓶颈分析与优化策略报告。

## 2. 硬约束（执行中）
- baseline 目录只读，不修改原样例。
- 所有改动都在 `13_matmulleakyrelu_kernellaunch/Optimized/` 新目录。
- 优先 Async 主线优化，再考虑 frameworklaunch 迁移。

## 3. 今日已完成（代码层）
### 3.1 新目录与复制
- 新建：`Optimized/v1_shape_parallel/`
- 从 baseline 复制到优化目录后改动。

### 3.2 参数化与并行度改造
- `main.cpp`：去除固定 M/N/K，改为读取环境变量 `MATMUL_M/MATMUL_N/MATMUL_K`。
- `matmul_leakyrelu_custom_tiling.cpp`：`GenerateTiling(...)` 改为传入 shape，并做 `SetDim` 动态并行度。
- 增加 `MATMUL_FORCE_CORE_NUM`，用于单变量 A/B（固定核数 vs 自适应核数）。
- `scripts/gen_data.py`：支持按 shape 生成数据。

### 3.3 运行脚本增强
- `run.sh` 支持 `--m/--n/--k/--repeat/--force-core`。
- 输出性能统计：`AVG/P50/P90`。

### 3.4 第一轮反思已落实
- 只保留一条优化主线：删除 `Optimized/v1_shape_parallel/MatmulLeakyReluInvocation`，保留 `.../MatmulLeakyReluInvocationAsync`。
- `run.sh` 参数风格回退为旧版：仅 `-r cpu` / `-r sim` / `-r npu`。

## 4. 当前有效优化主路径
- `envtrial/samples/operator/ascendc/0_introduction/13_matmulleakyrelu_kernellaunch/Optimized/v1_shape_parallel/MatmulLeakyReluInvocationAsync`

## 5. 终端执行关键信息（摘要）
- 已验证：
  - `bash run.sh -r --cpu ...` 会按预期报 RUN_MODE 错误（已禁用该错误参数风格）。
  - `bash run.sh -r cpu ...` 参数解析正常。
- 高维实测阻塞：
  - `cpu` 模式在高维 shape 执行时间非常长，且会出现残留子进程干扰采样。
  - `sim` 模式构建命中 `ascendc_kernels_sim_precompile... File name too long`，当前环境未打通。

## 6. 已知问题与风险
1. 高维 shape 的稳定性能采样尚未完成（缺少完整 baseline vs optimized 表）。
2. 高维下曾出现 `gen tiling failed`，已加入保守 fallback（`SetDim(1)` 回退）以保证可继续调试。
3. 当前 `run.sh` 每次会全量重编译，测量噪声和耗时较大。

## 7. 下一次接续（直接照做）
1. 固定单 shape（先 `(2048,2048,2048)`），先打通“可稳定结束 + 正确性 pass”的一次闭环。
2. 分离编译与运行：编译一次后重复执行二进制，降低统计噪声。
3. 做单变量 A/B：
   - Baseline：`--force-core 1`
   - Optimized：`--force-core 0`
   - 同 shape 下输出误差与 `AVG/P50/P90`。
4. 复用同流程跑 `(4096,1024,4096)`。
5. 形成对比表并判断是否达到 `>=20%`；若未达标，优先调 `baseM/baseN` 档位与 split 策略。

## 8. 直接复现命令（接续模板）
```bash
cd envtrial/samples/operator/ascendc/0_introduction/13_matmulleakyrelu_kernellaunch/Optimized/v1_shape_parallel/MatmulLeakyReluInvocationAsync

# baseline-like（单核保守）
bash run.sh -r cpu -v Ascend910B1 --m 2048 --n 2048 --k 2048 --repeat 5 --force-core 1

# optimized（自适应并行）
bash run.sh -r cpu -v Ascend910B1 --m 2048 --n 2048 --k 2048 --repeat 5 --force-core 0
```

## 9. 关联文档
- `要求/实现路径.md`
- `要求/M1_基线与瓶颈初判.md`
- `envtrial/samples/operator/ascendc/0_introduction/13_matmulleakyrelu_kernellaunch/开发日志.md`

