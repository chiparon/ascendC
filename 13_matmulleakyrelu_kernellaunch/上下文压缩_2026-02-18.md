# MatmulLeakyRelu（Ascend C）上下文压缩（2026-02-18）

## 1. 当前状态标记
- 当前验证推进状态：`暂停`（按用户要求暂停继续跑验证）。
- 暂停点：KernelLaunch 路径已完成本轮 A/B 与 core sweep/core compare，等待后续统一恢复。

## 2. 对照任务书与实现路径的进度

### 2.1 目标对照
- 任务书（`/home/viparon/share/VMShare/AIal/要求/leakyrelu`）目标：
  - 高维 shape（至少 S1/S2）性能提升 `>=20%`
  - 接口兼容、精度正确
  - 输出性能分析（msprof/APROF）
- 实现路径（`/home/viparon/share/VMShare/AIal/要求/实现路径.md`）：
  - M1 基线与瓶颈
  - M2 KernelLaunch 达标
  - M3 FrameworkLaunch 迁移
  - M4 最终报告

### 2.2 当前算子算法与推荐路径对比
1. Tiling 策略（已做）
- 已具备：动态 shape、split/core 搜索、shape key、合法性校验。
- 现状：能够稳定生成可运行 tiling，并支持 force-core 对照。

2. UB/L1 分配与复用（部分完成）
- 已具备：LeakyReLU 队列化出入（修复了 in-place 路径引发的高维结果错误）。
- 缺口：尚未进入更细的 UB/L1 档位扫描与系统化参数搜索。

3. 流水编排（部分完成）
- 已具备：`Iterate<false>` 异步路径与分块处理。
- 缺口：尚未建立“仅 kernel 时间”闭环驱动的流水参数优化。

4. 融合优化（基础完成）
- 已具备：MatMul + Bias + LeakyReLU 一体化路径。
- 缺口：尚无分 shape 的融合访存差异化策略。

5. 性能分析工具链（本轮补齐）
- 已在 `run.sh` 增加可选 kernel msprof 采集（保留原端到端 PERF）。
- 作用：同时记录“总耗时”和“kernel 耗时”，避免口径偏差。

## 3. 最新有效结果（NPU, 910B3）
- 数据源：`/home/viparon/share/VMShare/AIal/kernel_results/v2_try3_corecompare.md`
- 精度：S2/S3 A/B 均 `error ratio: 0.0000`、`test pass`
- 性能（core=4 vs core=2）：
  - `S3 (1024,512,1024)`：`5388.969 -> 5325.287 ms`，约 `+1.18%`
  - `S2 (4096,1024,4096)`：`5810.810 -> 5386.045 ms`，约 `+7.31%`
- 结论：M2（高维 `>=20%`）`未达标`。

## 4. 为什么多 shape 都在 5~6 秒
- 当前 `PERF` 计时包含整进程固定开销（ACL init/malloc/memcpy/finalize），shape 间差异被淹没。
- 该现象已被确认，因此后续必须同时看 kernel-msprof 数据做归因。

## 5. 下一阶段优化方向（恢复验证后执行）
1. 先以 msprof kernel-time 为主口径做 A/B 决策（保留总耗时为辅口径）。
2. 针对 S1/S2/S3 分 shape 做 tiling 档位细化（baseM/baseN + core 映射）。
3. 以“单变量”推进 UB/L1/流水参数搜索，避免结论混叠。
4. 在 KernelLaunch 达到高维 `>=20%` 后，再迁移到 FrameworkLaunch（M3）。

## 6. 防偏移约束（AIal 目录权威文件）
以下文件为后续会话优先参考的“权威上下文”，用于防止任务偏移：
1. 目标与评分约束：
   - `/home/viparon/share/VMShare/AIal/要求/leakyrelu`
2. 里程碑与流程约束：
   - `/home/viparon/share/VMShare/AIal/要求/实现路径.md`
3. 最新有效结果（优先）：
   - `/home/viparon/share/VMShare/AIal/kernel_results/v2_try3_corecompare.md`
   - `/home/viparon/share/VMShare/AIal/kernel_results/v2_try3_coresweep.md`
   - `/home/viparon/share/VMShare/AIal/kernel_results/v2_try3.md`
4. 历史参考（低优先）：
   - `/home/viparon/share/VMShare/AIal/kernel_results/v2_try1.md`
   - `/home/viparon/share/VMShare/AIal/kernel_results/v2_try2.md`
   - `/home/viparon/share/VMShare/AIal/kernel_results/results.md`

## 7. 本轮代码面已完成
- `Optimized/v2_algorithm/MatmulLeakyReluInvocationAsync/run.sh`
  - 新增参数：
    - `--kernel-msprof`
    - `--msprof-repeat`
    - `--msprof-output`
  - 保留原 `PERF` 统计，不改现有测试口径。
