# MatmulLeakyRelu（Ascend C）上下文压缩（2026-02-17）

## 1. 总目标（未变）
- 高维 shape（至少 `S1=(2048,2048,2048)`、`S2=(4096,1024,4096)`）性能较 baseline 提升 `>=20%`。
- 保持接口兼容与正确性（误差阈值通过）。
- 交付代码 + 性能数据 + 分析报告。

## 2. 本轮核心结论
1. `(512,128,512)` 已在优化路径稳定可跑并精度通过，且记录 `tiling key=1`。
2. 发现并修复 CPU 路径动态 tiling 的 `blockDim` 错误（此前固定 `blockDim=1` 会导致高维输出后半段为 0）。
3. 自适应核心数增加上限（默认 4）后，高维在本地 `-r cpu` 可稳定完成并通过精度。
4. NPU 实测结果（`/home/viparon/AIal/results.md`）显示优化收益不稳定，整体未达 `>=20%` 目标。

## 3. 代码改动（本轮有效）

### 3.1 tiling 策略与健壮性
- 文件：`Optimized/v1_shape_parallel/MatmulLeakyReluInvocationAsync/matmul_leakyrelu_custom_tiling.cpp`
- 变更：
  - `GenerateTiling(...)` 支持动态 shape + 多候选 split/core 搜索；
  - 优先尝试多核方案，再回退单核；
  - 增加 tile 形态合法性检查（`singleCoreM/N` 与 `baseM/N` 关系）；
  - 增加 `tiling key` 概念：
    - `S4=(512,128,512)` -> `key=1`
    - 其他 -> `key=0`
  - 运行日志会打印最终选中的 `key/core/baseM/baseN`。

### 3.2 host 侧运行参数与保护
- 文件：`Optimized/v1_shape_parallel/MatmulLeakyReluInvocationAsync/main.cpp`
- 变更：
  - shape 从环境变量读取（已在此前完成，本轮沿用）；
  - `GenerateTiling` 失败与零字段做 fail-fast；
  - 对非 310P 平台，屏蔽已知错误的单核路径（`usedCoreNum < 2` 直接报错）；
  - 修复 CPU 构建冲突（`tiling` 变量重名问题）；
  - CPU 与非 CPU 统一按 tiling 推导 `blockDim`（修复高维错结果问题）；
  - 自适应核心上限：`MATMUL_ADAPTIVE_MAX_CORE`（默认 `4`）。

### 3.3 脚本与文档
- 新增：`NPU复现实验包.md`（NPU复现实验命令包）
- 更新：`开发日志.md`（记录 S3/S1/S2 当前进展）

## 4. 关键验证结果

### 4.1 S4 特殊 shape 可用性
- `S4=(512,128,512)`：
  - 选中 `tiling key=1 core=2 baseM=128 baseN=64`
  - `error ratio: 0.0000`，`test pass`

### 4.2 本地可控路径（CPU）验证
- `S3=(1024,512,1024)`：
  - A(`force-core=2`)：`117576.997 ms`
  - B(`force-core=0`)：`94100.600 ms`
  - 提升约 `20.0%`，均 pass
- `S1=(2048,2048,2048)`：
  - A(`core=2`)：`266478.058 ms`
  - B(`adaptive->core=4`)：`135694.095 ms`
  - 提升约 `49.1%`，均 pass
- `S2=(4096,1024,4096)`：
  - A(`core=2`)：`535208.601 ms`
  - B(`adaptive->core=4`)：`276714.042 ms`
  - 提升约 `48.3%`，均 pass

### 4.3 NPU 结果复盘（用户实测）
- 数据源：`/home/viparon/AIal/results.md`
- `Ascend910B1`：
  - S1: `+2.25%`
  - S2: `+4.97%`
  - S3: `-5.13%`（回退）
- `Ascend910B3`：
  - S1: `-2.79%`（回退）
  - S2: `+6.34%`
  - S3: `+4.17%`
- 全部精度通过，但性能提升不稳定，未达目标。

## 5. 当前问题聚焦
1. A/B 仅用 `force-core` 区分时，收益在不同 SOC/shape 上波动大。
2. `S1@910B3` 与 `S3@910B1` 出现回退，需要针对性调参。
3. NPU实测中不同 shape 的时延分布较接近，需进一步确认统计口径是否充分隔离了非 kernel 开销（建议补 msprof kernel-time）。

## 6. 下一步建议（按优先级）
1. 固定 SOC 分批优化（先 `910B3`，再 `910B1`），每批只调单变量：
   - `baseM/baseN` 档位；
   - `adaptive max core`（2/4/6）；
   - `S1/S2/S3` 分 shape 特化 key（不仅 S4）。
2. 先修复回退点：
   - `S1@910B3`
   - `S3@910B1`
3. 统一复测口径：
   - build once + run-only；
   - 每 case `repeat>=5`；
   - 记录 `AVG/P50/P90` + `msprof` kernel 时间（若可用）。
4. 达到高维 `>=20%` 后再收敛到最终参数并固化报告材料。

## 7. 关键路径（当前主线）
- `envtrial/samples/operator/ascendc/0_introduction/13_matmulleakyrelu_kernellaunch/Optimized/v1_shape_parallel/MatmulLeakyReluInvocationAsync`

