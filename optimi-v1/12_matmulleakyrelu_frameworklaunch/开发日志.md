# 12_matmulleakyrelu_frameworklaunch 开发日志

## Round 1
- 本轮优化方向：
  - 仅调整 kernel 侧 `splitRowNums` 固定值问题，改为按 `baseM/baseN/singleCoreM` 自适应选择分行数，目标是减少不合适切分带来的向量段过小问题。
- 代码改动：
  - `MatmulLeakyReluCustom/op_kernel/matmul_leakyrelu_custom.cpp`
  - 新增 `SelectSplitRowNums(...)`，按 `8 -> 4 -> 2 -> 1` 回退，要求：
    - `baseM % split == 0`
    - `singleCoreM % splitRowSize == 0`
    - `splitRowSize * baseN >= 1024`（避免过小片段）
  - `Init()` 中 `splitRowNums` 从固定 `4` 改为自适应。
- 逻辑初验与输入模拟推理：
  - 用本机 Python 对 S1/S2/S3/S4 典型 tile 参数推演 `CopyOut` 偏移映射，`startOffset` 无重复、覆盖段数匹配。
  - 验证结果：`segments == uniqStarts`，未出现重复写偏移。
- 结论：
  - 保持算子计算语义不变，仅改变切分粒度策略，为后续 round 的多 shape 调优提供稳定基础。

## Round 2
- 本轮优化方向：
  - 降低 kernel 内循环的重复标量计算开销（`CopyOut` 参数前移初始化）。
- 代码改动：
  - `MatmulLeakyReluCustom/op_kernel/matmul_leakyrelu_custom.cpp`
  - 在 `Init()` 预计算并缓存：
    - `roundM`
    - `AscendC::DataCopyParams copyParam`
  - `CopyOut()` 改为直接复用缓存参数，去掉每次循环重建结构体。
- 逻辑初验与输入模拟推理：
  - 该改动不改变偏移公式与 copy 参数值来源，仅计算时机从循环内移到初始化阶段。
  - `startOffset` 公式保持不变，写回区域等价。
- 结论：
  - 语义不变、热点路径标量开销更小，为后续 NPU 实测提供更干净的 kernel 行为基线。

## Round 3
- 本轮优化方向：
  - 收敛 host tiling 搜索策略，避免 910B 上无效单核 fallback。
- 代码改动：
  - `MatmulLeakyReluCustom/op_host/matmul_leakyrelu_custom.cpp`
    - 提前识别 `is310p`。
    - 单核 fallback 仅在 `310P` 打开；`910B` 不再进入单核尝试。
    - `tiling failed` 日志补充 `soc` 信息，便于 NPU 环境问题定位。
- 逻辑初验与输入模拟推理：
  - 910B 路径上，搜索空间从“多核 + 单核”收敛到“多核”。
  - 与既有约束（910B 下 `usedCoreNum<2` 直接失败）保持一致。
- 结论：
  - 减少无效搜索与歧义回退，提升高维 shape 调参时的可解释性。
