# 14_reduce_frameworklaunch 开发日志

## Round 1
- 本轮优化方向：
  - 先修复 dtype 路径一致性：host 声明支持 `float16/float`，但 kernel 原实现仅实例化 `float`。
- 代码改动：
  - `ReduceCustom/op_host/reduce_custom.cpp`
    - 新增 float16 专用 key：`11/12/13`。
    - key 选择改为按 dtype 分流；float16 仅使用通用路径（1/2/3 语义对应），float 继续保留 `4/5` 特化路径。
    - 增加默认回退 key，避免部分 shape 下 key 未设置。
  - `ReduceCustom/op_kernel/reduce_custom.cpp`
    - 按 key 分支分别实例化 `KernelReduce<float>` 与 `KernelReduce<half>`。
    - float16 key 映射到 `Compute1/2/3` 对应流程。
- 逻辑初验与输入模拟推理：
  - 用本机 Python 推导 key 映射，验证 `float16/float` 在阈值边界与大尺寸场景均有明确分支。
  - 验证结果：float16 不再走 float-only 的 `Compute4/5` 路径。
- 结论：
  - 本轮完成了类型正确性补齐，避免“接口支持但 kernel 未实现”的隐性风险；后续可在 round2 做 reduce 分块并行与 UB 策略优化。

## Round 2
- 本轮优化方向：
  - 减少 `Compute2/Compute3` 的 UB 临时缓冲占用，避免按 `totalLength` 过量申请。
- 代码改动：
  - `ReduceCustom/op_kernel/reduce_custom.cpp`
    - `Compute2`：`calcBuf` 大小改为 `blockNum0 * sizeof(DTYPE)`。
    - `Compute3`：`calcBuf` 大小改为 `repeatNum * sizeof(DTYPE)`。
- 逻辑初验与输入模拟推理：
  - 本机 Python 计算对比显示中间缓冲显著下降（如 `total=4096,float`：`16384B -> 2048B/256B`）。
  - 中间张量长度与后续 `WholeReduceSum/BlockReduceSum` 消费长度一致。
- 结论：
  - 在不改变 reduce 计算逻辑的前提下完成 UB 缩容，为高维场景稳定性留出空间。

## Round 3
- 本轮优化方向：
  - 修正小尺寸路径的掩码精度，确保按真实 `totalLength` 归约。
- 代码改动：
  - `ReduceCustom/op_kernel/reduce_custom.cpp`
    - `Compute1` 从固定 `maskLen` 切换到 `SetMaskCount + SetVectorMask(totalLength)`。
    - 增加 `PipeBarrier` 与 `SetMaskNorm`，与 `Compute2/3` 对齐。
    - `Compute4/5` 的 cycle 统计变量显式 `(void)` 处理，避免无用告警干扰。
- 逻辑初验与输入模拟推理：
  - 计数掩码路径下，`totalLength <= threshold0` 时只处理有效元素，不依赖固定向量长度。
  - 该变更仅影响 mask 设定，不改变输出张量格式与 API。
- 结论：
  - reduce 小输入路径的边界语义更稳，适合作为后续动态 shape 基线。
